<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarEnergy - Mantenimiento</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .sidebar { transition: all 0.3s ease; }
        .dashboard-card { transition: all 0.3s ease; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .cal-box { background: #fff; padding: 18px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar (copiado del user-dashboard) -->
        <div class="sidebar bg-blue-900 text-white w-64 space-y-6 py-7 px-2 fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition duration-200 ease-in-out z-50">
            <div class="flex items-center space-x-2 px-4">
                <i data-feather="sun" class="text-yellow-500 w-8 h-8"></i>
                <span class="text-xl font-bold">SolarEnergy</span>
            </div>
            <nav>
                <div class="px-4 py-3 text-blue-200 text-sm font-medium">MENÚ PRINCIPAL</div>
                <a id="linkDashboard" href="user-dashboard.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center">
                    <i data-feather="home" class="mr-2 w-5 h-5"></i> Inicio
                </a>
    
                <a href="monitoring.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
                    <i data-feather="activity" class="mr-2 w-5 h-5"></i> Monitoreo
                </a>
                <a href="payments.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
                    <i data-feather="credit-card" class="mr-2 w-5 h-5"></i> Pagos
                </a>
                                <!-- support/admin link will be injected here based on user role -->
                    <div id="supportItem" class="px-2 mt-2"></div>


                <a href="settings.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
                    <i data-feather="settings" class="mr-2 w-5 h-5"></i> Configuración
                </a>

                <div class="px-4 py-3 text-blue-200 text-sm font-medium mt-8">TU SISTEMA</div>
                <a href="#" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
                    <i data-feather="battery" class="mr-2 w-5 h-5"></i> Baterías
                </a>
                <a href="#" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
                    <i data-feather="calendar" class="mr-2 w-5 h-5"></i> Mantenimiento
                </a>
                <a href="documents.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
                    <i data-feather="file-text" class="mr-2 w-5 h-5"></i> Documentos
                </a>
                </nav>
                <div class="px-4 mt-10">
                    <button id="btnLogout" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded transition">
                        <i data-feather="log-out" class="inline w-4 h-4 mr-2"></i> Cerrar sesión
                    </button>
                </div>
        </div>

        <!-- Backdrop for mobile -->
        <div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 md:hidden" style="display: none;" id="sidebarBackdrop"></div>

        <!-- Main content -->
        <div class="flex-1 md:ml-64 p-6">
            <header class="bg-white shadow mb-6 p-4 rounded-md">
                <h1 class="text-2xl font-bold text-blue-900">Mantenimiento de tu Sistema</h1>
                <p class="text-gray-600">Controla las fechas de mantenimiento y solicita una cita fácilmente.</p>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <section class="cal-box">
                    <h2 class="text-lg font-semibold text-solar-dark mb-4">Información del Mantenimiento</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700">Fecha de instalación</label>
                            <!-- Read-only: value is loaded from the backend -->
                            <input id="installDate" type="date" disabled class="mt-2 w-full px-3 py-2 border rounded-lg bg-gray-100" title="La fecha se obtiene del servidor" />
                        </div>

                        <div>
                            <label class="block text-gray-700">Próximo mantenimiento</label>
                            <div id="nextMaintenance" class="mt-2 text-lg font-bold text-green-600">—</div>
                        </div>

                        <div>
                            <label class="block text-gray-700">Último mantenimiento</label>
                            <div id="lastMaintenance" class="mt-2 text-gray-700">—</div>
                        </div>

                        <div>
                            <label class="block text-gray-700">Próximos mantenimientos (6 en total cada 6 meses)</label>
                            <ul id="maintenanceList" class="mt-2 list-disc pl-5 text-gray-700"></ul>
                        </div>

                        <div>
                            <button id="requestWhatsApp" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold">Pedir cita por WhatsApp</button>
                        </div>

                        <!-- Saving installation date is disabled; value comes from backend -->
                    </div>
                </section>

                <section class="cal-box">
                    <h2 class="text-lg font-semibold text-solar-dark mb-4">Agendar en Calendly</h2>
                    <!-- Calendly inline widget begin -->
                    <div class="calendly-inline-widget" data-url="https://calendly.com/1193560893-u/30min" style="min-width:320px;height:700px;"></div>
                    <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
                    <!-- Calendly inline widget end -->
                </section>
            </main>

            <footer class="mt-8 text-sm text-gray-500">Si necesitas asistencia inmediata llama a +57 318 456 7890</footer>
        </div>
    </div>

    <script>
        // Initialize AOS
        AOS.init({ duration: 700, once: true });

        // Feather icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof feather !== 'undefined') feather.replace();
        });

                // Populate support/admin link in sidebar based on role
                function loadProfile() {
                    try {
                        const t = localStorage.getItem('token');
                        if (!t) return;
                        const payload = parseJwt(t);
                                const myRole = payload.role;
                                const supportEl = document.getElementById('supportItem');
                                if (!supportEl) return;
                                if (myRole === 'SUPPORT') {
                                        supportEl.innerHTML = `\
                                            <a href="admin-dashboard.html" class="block py-2.5 px-4 rounded bg-blue-800 text-white flex items-center mt-4">\
                                                <i data-feather="help-circle" class="mr-2 w-5 h-5 text-blue-200"></i> Admin de usuarios\
                                            </a>`;
                                } else {
                                        supportEl.innerHTML = `\
                                            <a href="soporte.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">\
                                                <i data-feather="help-circle" class="mr-2 w-5 h-5"></i> Soporte\
                                            </a>`;
                                }
                                if (typeof feather !== 'undefined') feather.replace();
                        } catch (e) {
                                // ignore
                        }
                }

                // run profile loader early
                loadProfile();

        // Sidebar mobile toggle
        document.getElementById('mobileMenuButton')?.addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            sidebar.classList.toggle('-translate-x-full');
            backdrop.style.display = backdrop.style.display === 'block' ? 'none' : 'block';
        });
        document.getElementById('sidebarBackdrop')?.addEventListener('click', function() {
            document.querySelector('.sidebar')?.classList.add('-translate-x-full');
            this.style.display = 'none';
        });

        // Logout behavior
        document.getElementById('btnLogout')?.addEventListener('click', function(){
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        // Utility: add months
        function addMonths(date, months) {
            const d = new Date(date);
            const day = d.getDate();
            d.setMonth(d.getMonth() + months);
            // handle month overflow
            if (d.getDate() !== day) d.setDate(0);
            return d;
        }

        // Format date
        function formatDate(d) {
            return d.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // API and auth
        const API = 'http://localhost:3000/api';
        const token = localStorage.getItem('token');
        function parseJwt(token) {
            try {
                const b = token.split('.')[1];
                return JSON.parse(decodeURIComponent(atob(b).split('').map(function(c) { return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join('')));
            } catch (e) { return {}; }
        }

        const installInput = document.getElementById('installDate');
        const requestBtn = document.getElementById('requestWhatsApp');
        // start disabled until we have a date from the backend
        if (requestBtn) {
            requestBtn.disabled = true;
            requestBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Helper: parse a date-only string (YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS...) into a local Date at midnight
        function parseDateOnly(dateStr) {
            if (!dateStr) return null;
            const part = dateStr.split('T')[0];
            const [y, m, d] = part.split('-').map(Number);
            if (!y || !m || !d) return null;
            return new Date(y, m - 1, d);
        }

        // Load installation and last maintenance from backend for authenticated user
        async function loadInstallation() {
            if (!token) return; // not authenticated
            const payload = parseJwt(token);
            const myId = payload.id;
            if (!myId) return;
            try {
                const res = await fetch(API + '/users/' + myId, { headers: { Authorization: 'Bearer ' + token } });
                if (!res.ok) return;
                const user = await res.json();
                // show installationDate in the read-only input if available (avoid timezone shifts)
                const instStr = user.installationDate ? String(user.installationDate) : null;
                if (instStr) {
                    // take only the date part
                    const instDatePart = instStr.split('T')[0];
                    installInput.value = instDatePart;
                } else {
                    installInput.value = '';
                }

                // show lastMaintenance in the display (avoid timezone shifts)
                const lastStr = user.lastMaintenance ? String(user.lastMaintenance) : null;
                if (lastStr) {
                    const lastDate = parseDateOnly(lastStr);
                    document.getElementById('lastMaintenance').textContent = formatDate(lastDate);
                } else {
                    document.getElementById('lastMaintenance').textContent = '—';
                }

                // prefer lastMaintenance as the basis for next maintenance; fallback to installationDate
                const baseDate = lastStr ? parseDateOnly(lastStr) : (instStr ? parseDateOnly(instStr) : null);

                if (baseDate) {
                    computeAndRender(baseDate, instStr || null);
                } else {
                    // no relevant date in DB
                    document.getElementById('nextMaintenance').textContent = 'Fecha de instalación no registrada';
                    document.getElementById('maintenanceList').innerHTML = '';
                    if (requestBtn) {
                        requestBtn.disabled = true;
                        requestBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            } catch (err) {
                console.warn('No se pudo cargar instalación desde backend', err);
            }
        }

        loadInstallation();

        // Compute next maintenance and list
        // computeAndRender: baseDate is either lastMaintenance (preferred) or installationDate; installDateParam is optional original installationDate
        function computeAndRender(baseDate, installDateParam) {
            if (!baseDate || isNaN(baseDate)) return;
            const now = new Date();

            // Build next 6 maintenances every 6 months starting from the baseDate
            const list = [];
            for (let i = 1; i <= 6; i++) {
                const monthsToAdd = i * 6;
                const d = addMonths(baseDate, monthsToAdd);
                list.push(d);
            }

            // Find next upcoming maintenance
            const next = list.find(d => d >= now) || list[list.length-1];

            document.getElementById('nextMaintenance').textContent = formatDate(next);

            // Render list
            const ul = document.getElementById('maintenanceList');
            ul.innerHTML = '';
            list.forEach(d => {
                const li = document.createElement('li');
                li.textContent = formatDate(d);
                ul.appendChild(li);
            });

            // Set WhatsApp button link with prefilled message (enable button)
            const phone = '+573159620834';
            const phoneDigits = phone.replace(/\D/g, '');
            // If we have an installationDate, include it in the message; otherwise omit
            const installPart = installDateParam ? ` Mi instalación fue el ${formatDate(parseDateOnly(installDateParam))}.` : '';
            const message = `Hola, quiero agendar una cita para mantenimiento de mi sistema el ${formatDate(next)}.${installPart}`;
            const encoded = encodeURIComponent(message);
            const waUrl = `https://api.whatsapp.com/send?phone=${phoneDigits}&text=${encoded}`;
            if (requestBtn) {
                requestBtn.disabled = false;
                requestBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                requestBtn.onclick = () => window.open(waUrl, '_blank');
            }
        }
        // Note: saving the installation date from the client is disabled. The date is authoritative from the server.
    </script>
</body>
</html>