<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - SolarEnergy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar -->
  <div class="sidebar bg-blue-900 text-white w-64 space-y-6 py-7 px-2 fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition duration-200 ease-in-out z-50">
    <div class="flex items-center space-x-2 px-4">
      <i data-feather="sun" class="text-yellow-500 w-8 h-8"></i>
      <span class="text-xl font-bold">SolarEnergy</span>
    </div>
    <nav>
      <div class="px-4 py-3 text-blue-200 text-sm font-medium">MENÚ PRINCIPAL</div>
      <a id="linkDashboard" href="user-dashboard.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="home" class="mr-2 w-5 h-5"></i> Inicio
      </a>
      <a href="monitoring.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="activity" class="mr-2 w-5 h-5"></i> Monitoreo
      </a>
      <a href="payments.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="credit-card" class="mr-2 w-5 h-5"></i> Pagos
      </a>

      <!-- Support item - populated by JS -->
      <div id="supportItem" class="px-2 mt-2"></div>

      <a href="settings.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="settings" class="mr-2 w-5 h-5"></i> Configuración
      </a>

      <div class="px-4 py-3 text-blue-200 text-sm font-medium mt-8">TU SISTEMA</div>
      <a href="#" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="battery" class="mr-2 w-5 h-5"></i> Baterías
      </a>
      <a href="maintenance.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="calendar" class="mr-2 w-5 h-5"></i> Mantenimiento
      </a>
      <a href="documents.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">
        <i data-feather="file-text" class="mr-2 w-5 h-5"></i> Documentos
      </a>
    </nav>

    <div class="px-4 mt-10">
      <button id="btnLogout" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded transition">
      <i data-feather="log-out" class="inline w-4 h-4 mr-2"></i> Cerrar sesión
      </button>
    </div>
  </div>

  <!-- Backdrop para móvil -->
  <div id="sidebarBackdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden md:hidden"></div>

  <!-- Contenedor principal -->
  <div class="flex-1 flex flex-col md:ml-64">
    
    <!-- Topbar móvil -->
    <header class="md:hidden w-full bg-white border-b p-3 flex justify-between items-center">
      <button id="openSidebar" class="text-blue-900">
        <i data-feather="menu" class="w-6 h-6"></i>
      </button>
      <div class="text-lg font-bold text-blue-900">SolarEnergy - Admin</div>
      <button id="m_btnLogout" class="text-sm px-2 py-1 rounded text-red-600">Cerrar</button>
    </header>

    <!-- Contenido -->
    <main class="flex-1 p-6 space-y-6">

      <!-- Resumen -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">Resumen</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div><canvas id="chartProduction" height="150"></canvas></div>
          <div><canvas id="chartConsumption" height="150"></canvas></div>
        </div>
      </section>

      <!-- Crear usuario -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Crear usuario</h2>
        <form id="createForm" class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input id="c_name" placeholder="Nombre" class="p-2 border rounded" required />
          <input id="c_email" placeholder="Correo" type="email" class="p-2 border rounded" required />
          <input id="c_password" placeholder="Contraseña" type="password" class="p-2 border rounded" required />
          <select id="c_role" class="p-2 border rounded">
            <option value="CLIENT">CLIENT</option>
            <option value="SUPPORT">SUPPORT</option>
          </select>
          <div class="md:col-span-4 flex justify-end">
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Crear</button>
          </div>
        </form>
      </section>

      <!-- Tabla de usuarios -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Usuarios</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">ID</th>
                <th class="px-4 py-2 text-left">Nombre</th>
                <th class="px-4 py-2 text-left">Email</th>
                <th class="px-4 py-2 text-left">Rol</th>
                <th class="px-4 py-2 text-left">Fecha instalación</th>
                <th class="px-4 py-2 text-left">Último mantenimiento</th>
                <th class="px-4 py-2 text-left">Creado</th>
                <th class="px-4 py-2 text-left">Acciones</th>
              </tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <script>
  const API = 'http://localhost:3000/api';
  const token = localStorage.getItem('token');
  if (!token) { alert('No autenticado. Redirigiendo a login.'); window.location.href='login.html'; }

  function parseJwt(token) {
    try {
      const b = token.split('.')[1];
      return JSON.parse(decodeURIComponent(atob(b).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join('')));
    } catch(e){ return {}; }
  }

  async function api(path, opts = {}) {
    opts.headers = { ...(opts.headers||{}), 'Content-Type': 'application/json', Authorization: 'Bearer ' + token };
    const res = await fetch(API + path, opts);
    const txt = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(txt) }; } catch(e) { return { ok: res.ok, status: res.status, data: txt }; }
  }

  // Populate support/admin link based on role
  async function loadProfile() {
    const payload = parseJwt(token);
    const myId = payload.id;
    const myRole = payload.role;
    if (!myId) { localStorage.removeItem('token'); window.location.href='login.html'; return; }

      if (myRole === 'SUPPORT') {
        document.getElementById('supportItem').innerHTML = `\
          <a id="linkSupportAdmin" href="admin-dashboard.html" class="block py-2.5 px-4 rounded bg-blue-800 text-white flex items-center mt-4">\
            <i data-feather="help-circle" class="mr-2 w-5 h-5 text-blue-200"></i> Admin de usuarios\
          </a>`;
        // linkDashboard should always go to user dashboard per requirement
        const linkDash = document.getElementById('linkDashboard'); if (linkDash) linkDash.href = 'user-dashboard.html';
      } else {
        document.getElementById('supportItem').innerHTML = `\
          <a id="linkSupportUser" href="soporte.html" class="block py-2.5 px-4 rounded hover:bg-blue-800 text-blue-200 hover:text-white transition flex items-center mt-1">\
            <i data-feather="help-circle" class="mr-2 w-5 h-5"></i> Soporte\
          </a>`;
        const linkDash = document.getElementById('linkDashboard'); if (linkDash) linkDash.href = 'user-dashboard.html';
      }
    feather.replace();
  }

  async function api(path, opts = {}) {
    opts.headers = { ...(opts.headers||{}), 'Content-Type': 'application/json', Authorization: 'Bearer ' + token };
    const res = await fetch(API + path, opts);
    const txt = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(txt) }; } catch(e) { return { ok: res.ok, status: res.status, data: txt }; }
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  async function loadUsers() {
    const r = await api('/users');
    if (!r.ok) { alert(r.data.message || 'Error cargando usuarios'); return; }
    const tbody = document.getElementById('usersTbody');
    tbody.innerHTML = '';
    r.data.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2 border">${u.id}</td>
        <td class="px-4 py-2 border">${escapeHtml(u.name)}</td>
        <td class="px-4 py-2 border">${escapeHtml(u.email)}</td>
        <td class="px-4 py-2 border">${u.role}</td>
        <td class="px-4 py-2 border">${u.installationDate ? new Date(u.installationDate).toLocaleDateString() : '-'}</td>
        <td class="px-4 py-2 border">${u.lastMaintenance ? new Date(u.lastMaintenance).toLocaleDateString() : '-'}</td>
        <td class="px-4 py-2 border">${new Date(u.createdAt).toLocaleString()}</td>
        <td class="px-4 py-2 border space-x-2">
          <button data-id="${u.id}" class="editBtn px-2 py-1 bg-blue-500 text-white rounded">Editar</button>
          <button data-id="${u.id}" class="delBtn px-2 py-1 bg-red-500 text-white rounded">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });

    // Render charts based on the freshly fetched user list
    try { renderUserCharts(r.data); } catch (e) { console.error('Error rendering charts', e); }

    document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', async (e) => {
      const id = e.currentTarget.dataset.id;
      if (!confirm('Eliminar usuario ' + id + '?')) return;
      const r = await api('/users/' + id, { method: 'DELETE' });
      if (r.status === 204 || r.ok) { loadUsers(); } else { alert(r.data.message || 'Error al eliminar'); }
    }));

    // Edit button handlers
    document.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', (e) => {
      const id = Number(e.currentTarget.dataset.id);
      // find user data from last fetched list (r.data)
      const u = r.data.find(x => x.id === id);
      if (!u) return alert('Usuario no encontrado');
      openEditModal(u);
    }));
  }

  // --- Edit modal logic ---
  function formatForInput(d) {
    if (!d) return '';
    try { return new Date(d).toISOString().split('T')[0]; } catch(e){ return ''; }
  }

  function openEditModal(user) {
    const modal = document.getElementById('editModal');
    document.getElementById('editUserId').textContent = user.id;
    document.getElementById('editName').textContent = user.name;
    document.getElementById('editInstallation').value = formatForInput(user.installationDate);
    document.getElementById('editLastMaintenance').value = formatForInput(user.lastMaintenance);
    modal.classList.remove('hidden');
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
  }

  async function saveEdit() {
    const id = Number(document.getElementById('editUserId').textContent);
    const installation = document.getElementById('editInstallation').value;
    const lastMaintenance = document.getElementById('editLastMaintenance').value;
    const body = {};
    // send undefined only if empty to avoid overwriting unintentionally? we'll send null if empty to clear
    body.installationDate = installation ? installation : null;
    body.lastMaintenance = lastMaintenance ? lastMaintenance : null;

    const r = await api('/users/' + id, { method: 'PUT', body: JSON.stringify(body) });
    if (!r.ok) return alert(r.data.message || 'Error al guardar');
    closeEditModal();
    loadUsers();
  }

  document.getElementById('createForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = c_name.value.trim(), email = c_email.value.trim(), password = c_password.value.trim(), role = c_role.value;
    if (!name || !email || !password) return alert('Completa los campos');
    const r = await api('/users', { method: 'POST', body: JSON.stringify({ name, email, password, role }) });
    if (!r.ok) return alert(r.data.message || 'Error creando');
    e.target.reset();
    loadUsers();
  });

  // Logout
  const logoutAll = () => { localStorage.removeItem('token'); window.location.href='login.html'; };
  document.getElementById('btnLogout').addEventListener('click', logoutAll);
  document.getElementById('m_btnLogout').addEventListener('click', logoutAll);

  // Sidebar móvil
  const sidebarEl = document.querySelector('.sidebar');
  const backdropEl = document.getElementById('sidebarBackdrop');
  document.getElementById('openSidebar').addEventListener('click', () => {
    sidebarEl.classList.toggle('-translate-x-full');
    backdropEl.style.display = backdropEl.style.display === 'block' ? 'none' : 'block';
  });
  backdropEl.addEventListener('click', () => {
    sidebarEl.classList.add('-translate-x-full');
    backdropEl.style.display = 'none';
  });

  // Gráficas de ejemplo
  // Charts driven by user data
  let chartRoles = null;
  let chartInstallations = null;

  function renderUserCharts(users) {
    // Compute roles distribution
    const roles = users.reduce((acc, u) => {
      acc[u.role] = (acc[u.role] || 0) + 1;
      return acc;
    }, {});

    const roleLabels = Object.keys(roles);
    const roleData = roleLabels.map(l => roles[l]);

    // Prepare last 12 months labels (from oldest to newest)
    const months = [];
    const counts = new Array(12).fill(0);
    const now = new Date();
    for (let i = 11; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push(d.toLocaleString('es-ES', { month: 'short', year: 'numeric' }));
    }

    // Count installations per month
    users.forEach(u => {
      if (!u.installationDate) return;
      const d = new Date(u.installationDate);
      if (isNaN(d)) return;
      // calculate months difference from start of the oldest bucket
      const oldest = new Date(now.getFullYear(), now.getMonth() - 11, 1);
      if (d < oldest) return;
      const diff = (d.getFullYear() - oldest.getFullYear()) * 12 + (d.getMonth() - oldest.getMonth());
      if (diff >= 0 && diff < 12) counts[diff] = counts[diff] + 1;
    });

    // Roles chart (doughnut) on #chartProduction
    const ctxRoles = document.getElementById('chartProduction');
    if (chartRoles) chartRoles.destroy();
    chartRoles = new Chart(ctxRoles, {
      type: 'doughnut',
      data: { labels: roleLabels, datasets: [{ data: roleData, backgroundColor: ['#10B981', '#1E3A8A', '#F59E0B'] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    // Installations per month chart (bar) on #chartConsumption
    const ctxInst = document.getElementById('chartConsumption');
    if (chartInstallations) chartInstallations.destroy();
    chartInstallations = new Chart(ctxInst, {
      type: 'bar',
      data: { labels: months, datasets: [{ label: 'Instalaciones', data: counts, backgroundColor: '#1E3A8A' }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // init sidebar links according to role
  loadProfile().then(() => {
    feather.replace();
    loadUsers();
  });
  </script>
  <!-- Edit modal -->
  <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center hidden">
    <div class="bg-white rounded shadow-lg w-11/12 md:w-1/3 p-4">
      <h3 class="text-lg font-semibold mb-2">Editar usuario <span id="editName" class="font-medium"></span> (<span id="editUserId"></span>)</h3>
      <div class="grid gap-2">
        <label class="text-sm">Fecha de instalación</label>
        <input id="editInstallation" type="date" class="p-2 border rounded" />
        <label class="text-sm">Último mantenimiento</label>
        <input id="editLastMaintenance" type="date" class="p-2 border rounded" />
      </div>
      <div class="mt-4 flex justify-end space-x-2">
        <button onclick="closeEditModal()" class="px-3 py-1 border rounded">Cancelar</button>
        <button onclick="saveEdit()" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
    </div>
  </div>
</body>
</html>
